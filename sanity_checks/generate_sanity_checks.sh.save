#!/bin/bash
echo "ðŸ”§ Setting up sanity check files in /sanity_checks..."

mkdir -p sanity_checks

# Test 1: config loading
cat > sanity_checks/test_config_loading.py << 'EOF'
import os, json
import sys, os
sys.path.append(os.path.abspath(os.path.join(os.path.dirname(__file__), '../sym')))

try:
    from utils import load_config
    config = load_config()
    assert "symbols" in config, "Symbols not found in config"
    assert "capital" in config, "Capital setting missing"
    print("âœ… config loading passed")
except Exception as e:
    print(f"âŒ config loading failed: {e}")
EOF

# Test 2: API credentials
cat > sanity_checks/test_api_credentials.py << 'EOF'
import os, json

try:
    creds_path = os.path.join("config", "api_keys.json")
    assert os.path.exists(creds_path), "Missing API key file"
    with open(creds_path) as f:
        creds = json.load(f)
    assert "alpaca_key" in creds and "alpaca_secret" in creds, "Alpaca credentials incomplete"
    print("âœ… API credentials passed")
except Exception as e:
    print(f"âŒ API credentials test failed: {e}")
EOF

# Test 3: signal engine
cat > sanity_checks/test_signal_engine.py << 'EOF'
try:
    from signal_engine import evaluate_signals
    result = evaluate_signals("AAPL")
    assert isinstance(result, dict), "Signal result is not a dictionary"
    print("âœ… signal engine passed")
except Exception as e:
    print(f"âŒ signal engine test failed: {e}")
EOF

# Test 4: trade executor
cat > sanity_checks/test_trade_execution.py << 'EOF'
try:
    from trade_executor import place_order
    order_id = place_order("AAPL", 100.0, 1, "buy", dry_run=True)
    assert order_id.startswith("dryrun-"), "Dry run order ID incorrect"
    print("âœ… trade execution passed")
except Exception as e:
    print(f"âŒ trade execution test failed: {e}")
EOF

# Test 5: telegram alerts
cat > sanity_checks/test_telegram_alerts.py << 'EOF'
try:
    from utils import notify_telegram
    notify_telegram("sanity-check", "Sanity check: Telegram is working")
    print("âœ… telegram alert passed (check your Telegram)")
except Exception as e:
    print(f"âŒ telegram alert test failed: {e}")
EOF

# Test 6: flask installed
cat > sanity_checks/test_flask_launch.py << 'EOF'
try:
    import subprocess
    result = subprocess.run(["flask", "--version"], capture_output=True, text=True)
    assert result.returncode == 0, "Flask not installed"
    print("âœ… flask installed and functional")
except Exception as e:
    print(f"âŒ flask launch test failed: {e}")
EOF

# Runner for all sanity tests
cat > sanity_checks/run_sanity_checks.py << 'EOF'
import os
import subprocess

print("ðŸ§ª Running all sanity checks...\n")
tests = [f for f in os.listdir(".") if f.startswith("test_") and f.endswith(".py")]
for test in sorted(tests):
    print(f"â–¶ï¸ {test}")
    subprocess.run(["python3", test])
    print()
EOF

chmod +x sanity_checks/*.py

echo "âœ… All sanity check scripts generated!"
